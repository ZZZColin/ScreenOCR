var W=Object.defineProperty;var Z=(e,t,r)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var A=(e,t,r)=>Z(e,typeof t!="symbol"?t+"":t,r);import{ac as $,ad as J,ae as X,a5 as o,q as g,r as v,af as q,ag as ee,R as te}from"./chunk.vendor.DXGcwdj3.js";import{A as se,R as re,D as ne,C as oe}from"./index.RyIKo0V9.js";import{L as k,T as ae,S as ce,B as V}from"./chunk.antd-vendor.TcWOth-p.js";class ie{constructor(){A(this,"dependencies");A(this,"values");A(this,"formulas");A(this,"reverseDeps");A(this,"_sortedNodes",null);this.dependencies={},this.reverseDeps={},this.values={},this.formulas={}}getAllNodes(){return Object.keys(this.dependencies)}addNode(t,r=[],n=null){if(this.dependencies[t])throw new Error("Node ".concat(t," already exists."));this.dependencies[t]=r,this.formulas[t]=n,this.values[t]=null,this.reverseDeps[t]=this.reverseDeps[t]||[];for(const s of r)this.reverseDeps[s]=this.reverseDeps[s]||[],this.reverseDeps[s].includes(t)||this.reverseDeps[s].push(t)}topologicalSort(){if(this._sortedNodes!==null)return this._sortedNodes;const t=[],r=new Set,n=s=>{r.has(s)||(r.add(s),(this.dependencies[s]||[]).forEach(n),t.push(s))};return Object.keys(this.dependencies).forEach(n),this._sortedNodes=t,t}computeAll(t){(t?this.topologicalSort().filter(n=>t.includes(n)):this.topologicalSort()).forEach(n=>{this.formulas[n]&&(this.values[n]=this.formulas[n](n))})}getAffectedNodes(t){const r=new Set,n=[t];for(;n.length>0;){const s=n.shift();for(const a of this.reverseDeps[s]||[])r.has(a)||(r.add(a),n.push(a))}return Array.from(r)}updateValue(t,r){this.values[t]=r;const n=this.getAffectedNodes(t);if(n.length===0)return;const s=this.topologicalSort().filter(a=>n.includes(a));for(const a of s)this.formulas[a]&&(this.values[a]=this.formulas[a](a))}getValues(){return this.values}hasCycle(){const t=new Set,r=new Set,n=s=>{if(r.has(s))return!0;if(t.has(s))return!1;r.add(s);for(const a of this.dependencies[s]||[])if(n(a))return!0;return r.delete(s),t.add(s),!1};for(const s of Object.keys(this.dependencies))if(n(s))return!0;return!1}}class le{constructor(){A(this,"graph");this.graph=new ie}build(){if(this.graph.hasCycle())throw new Error("Cycle detected in dependency graph");return this.graph}}const R="â€‹";function O(e){return e.replaceAll(R,"")}function P(e){return typeof e!="string"?!1:e.startsWith(R)}function de(e){return typeof e!="string"?!1:e.endsWith(R)}function F(e){return P(e)||de(e)}function z(){var e,t;return(t=(e=VBA_EE["Section: Data from Worklog"])==null?void 0:e.Carrier)!=null?t:"Unknown Carrier"}function ue(){var t;const e=VBA_EE["Section: Data from Worklog"];return{filename:(t=e["Naming String"])!=null?t:"".concat(z()),needPastingToClipboard:e["Paste to Clipboard"],fileMimeType:e["Exported MIME Type"],exportSuccessMessage:e["Export Success Notice"],exportFailMessage:e["Export Fail Notice"],validateFailMessage:e["Validate Fail Notice"]}}const he=";",pe=":",S=VBA_IFN,fe=VBA_EE,L=VBA_OFN,me=VBA_UI,_=VBA_Alert,xe=VBA_FORMULA_IFN,Ne=VBA_FORMULA_OFN,ge=VBA_FORMULA_ALERT,be=VBA_FORMULA_HIDDEN_SECTIONS,Ee=VBA_GENERATE_JSON;class ye extends le{constructor(){super()}fromJSON(){for(const[t,r]of Object.entries(L)){const n=this.buildDependsOnFromOFN(t,r),s=this.buildDependsOnFromAlert(t,_[t]);this.graph.addNode(t,Array.from(new Set([...n,...s])),Ne.bind(null,t,L,this.graph.getValues()))}for(const[t,r]of Object.entries(S)){const n=this.buildDependsOnFromIFN(t,r),s=this.buildDependsOnFromAlert(t,_[t]);this.graph.addNode(t,Array.from(new Set([...n,...s])),xe.bind(null,t,S,fe,this.graph.getValues()))}return this}buildDependsOnFromIFN(t,r){const n=[],s=r.Filter;return Object.keys(s).length&&Object.keys(s).filter(a=>{var d;return!!((d=s[a])!=null&&d.length)}).forEach(a=>{const d=s[a];n.push(a),d.forEach(i=>{P(i)&&n.push(O(i))})}),n}buildDependsOnFromOFN(t,r){const n=[],s=r["Source Key in IFN"];s in S&&n.push(s);const a=r.Mapping;if(Array.isArray(a)&&a.length)for(const i of a)i.forEach(l=>{let c=l;F(c)&&(c=O(c),n.indexOf(c)===-1&&n.push(c))});const d=r.Calculation;if(Array.isArray(d)&&d.length)for(const i of d)i.forEach(l=>{let c=l;F(c)&&(c=O(c),n.indexOf(c)===-1&&n.push(c))});return n}buildDependsOnFromAlert(t,r){if(!r)return[];const n=[],s=r.Mapping[0];if(Array.isArray(s)&&s.length)for(const d of s)d.forEach(i=>{let l=i;F(l)&&(l=O(l),n.indexOf(l)===-1&&t!==l&&n.push(l))});const a=r.Calculation[0];if(Array.isArray(a)&&a.length)for(const d of a)d.forEach(i=>{let l=i;F(l)&&(l=O(l),n.indexOf(l)===-1&&t!==l&&n.push(l))});return n}formula(){}}const y=new ye().fromJSON().build();console.log(y,"dependencyGraph");const je=e=>Object.prototype.toString.call(e)==="[object Object]",Ae=e=>new Date(e).toString()!=="Invalid Date";function De(e,t,r){const n=JSON.stringify(e,null,2),s=new Blob([n],{type:t}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}async function ve(e){try{await navigator.clipboard.writeText(e),console.log("Text copied to clipboard")}catch(t){console.error("Failed to copy text to clipboard:",t)}}var j=(e=>(e.TEXT="text",e.EMAIL="email",e.NUMBER="number",e.DATE="date",e.SELECT="select",e.RADIO="radio",e.CHECKBOX="checkbox",e.COMPOSE="compose",e))(j||{}),T=(e=>(e.INPUT="input",e.OUTPUT="output",e))(T||{}),D=(e=>(e.ALERT="ALERT",e.REMINDER="REMINDER",e))(D||{});const G="$$",Oe=e=>t=>t&&(e==="number"?Number(t):e==="date"?new Date(t):t),H=e=>t=>t&&(e==="number"?Number(t):e==="date"?Ae(t)?$(t).format("YYYY-MM-DD"):null:t),Ie=(e,t)=>Object.keys(e).reduce((r,n)=>(Object.keys(e[n]).forEach(s=>{e[n][s].actionIDs.forEach(d=>{const i=typeof t[s]>"u"?null:t[s];r[d]=String(i)})}),r),{}),Te=e=>Object.keys(e).reduce((t,r)=>(e[r]&&(t[r]=Y(e,r)),t),{}),B=e=>e.split(G)[1],Y=(e,t)=>{var r;return Object.keys(((r=e[t])==null?void 0:r.types)||{}).reduce((n,s)=>{var l;const i=(((l=e[t])==null?void 0:l.types)||{})[s].split(he).map(c=>{const[p,h]=c.split(pe);return{type:p,content:h}});return n.concat(i)},[])};function Ce({field:e}){if(!y.getAllNodes().includes(e.name))throw new Error("Field name is not a valid key: ".concat(e.name||e.label))}function Fe({field:e}){if(!e.type)throw new Error("Field type is missing: ".concat(e.name))}function Me({field:e}){e.id=[J(),e.name].join(G)}function we(e,t){const r={};return e.forEach(n=>{const s={};n.sections.forEach(a=>{a.fields.forEach(d=>{d.forEach(i=>{var l,c,p;i&&(Array.isArray(t)&&t.forEach(h=>{h({field:i,section:a,tab:n})}),i.id=(l=i.id)!=null?l:i.name,(p=s[c=i.name])!=null||(s[c]={type:i.type,registeredNames:[],actionIDs:[]}),s[i.name].registeredNames.push(i.id),i.actionID&&s[i.name].actionIDs.push(i.actionID))})})}),r[n.tabName]=s}),{fieldKeyMap:r}}const Se=e=>we(e,[Ce,Fe,Me]),_e=(e,t)=>{const r=y.getValues();return t=t||Object.keys(r),t.reduce((s,a)=>{const d=e[a].registeredNames,i=H(e[a].type)(r[a]);return d.forEach(l=>{s[l]=i}),s},{})},Re=e=>{const t=je(e.rules)?e.rules:{};return typeof t.validate=="function"?{...t,validate:t.validate(e.name,ge,_,y.getValues())}:t},ke=(e,t,r,n,s,a,d,i)=>{var N,E,x;const l="h-8 w-full rounded-[4px] placeholder:text-[#747881]  border-1  px-2 text-sm font-medium  border-[#E1E6EA] focus:outline-none",c=typeof e.options=="function"?e.options():(N=e.options)!=null?N:[],p=(E=e.placeholder)!=null?E:"Please select",h=!!e.readonly,f={"border-[#FB4671] focus:border-[#FB4671]":i,"bg-white":i&&a,"border-[#E1E6EA] focus:border-[#E1E6EA]":!i&&a,"border-[#dddfe1] focus:border-[#dddfe1]":!i&&d},m=h?"cursor-auto":"cursor-pointer";switch(e.type){case j.TEXT:case j.EMAIL:case j.NUMBER:return o.jsx("input",{disabled:h,className:g(l,m,f),type:e.type,placeholder:e.placeholder,...t(e.id,s),onChange:u=>{n(e.id,u.target.value)}});case j.DATE:return o.jsxs("div",{className:"relative w-full",children:[o.jsx("input",{disabled:h,className:g(l,m,f,"[&::-webkit-calendar-picker-indicator]:opacity-0",{"text-[#747881]":!r[e.id]}),type:e.type,placeholder:e.placeholder,...t(e.id,s),onChange:u=>{const b=new Date(u.target.value),C=new Date(b.getTime()-b.getTimezoneOffset()*6e4);n(e.id,C)},onClick:u=>{u.currentTarget.showPicker()}}),o.jsx("button",{type:"button",onClick:u=>{u.currentTarget.previousElementSibling.showPicker()},className:g("absolute inset-y-0 right-0 flex items-center pr-3",m),children:o.jsx(ne,{width:14,height:14})})]});case j.CHECKBOX:return o.jsx("input",{disabled:h,className:g("h-4 w-4",m,{}),type:e.type,...t(e.id,s),onChange:u=>{n(e.id,u.target.checked)}});case j.RADIO:return o.jsx("div",{className:"flex gap-2",children:c.map(u=>o.jsxs("div",{className:"mr-4 flex items-center",children:[o.jsx("input",{disabled:h,className:"mr-2 h-4 w-4",id:e.id+u.value,type:e.type,value:u.value,checked:r[e.id]===u.value,...t(e.id,s),onChange:b=>{n(e.id,b.target.value)}}),o.jsx("label",{className:"base-sm cursor-pointer font-medium text-[#0B0B0B]",htmlFor:e.id+u.value,children:u.label})]},e.id+u.value))});case j.SELECT:return o.jsxs("select",{disabled:h,className:g(l,m,"appearance-none bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTYuNTA1NTkgOS4xMDU0QzYuNzc4OTEgOS40MDkxIDcuMjIyNzkgOS40MDkxIDcuNDk2MTEgOS4xMDU0TDEwLjI5NDkgNS45OTU1QzEwLjQ5NjEgNS43NzE5OCAxMC41NTUyIDUuNDM5MTIgMTAuNDQ1OCA1LjE0NzU3QzEwLjMzNjUgNC44NTYwMSAxMC4wODI4IDQuNjY2NSA5Ljc5ODU5IDQuNjY2NUw0LjIwMDkzIDQuNjY4OTNDMy45MTg4NiA0LjY2ODkzIDMuNjYzMDIgNC44NTg0NCAzLjU1MzcgNS4xNUMzLjQ0NDM3IDUuNDQxNTUgMy41MDU1OSA1Ljc3NDQgMy43MDQ1NyA1Ljk5NzkzTDYuNTAzNCA5LjEwNzgyTDYuNTA1NTkgOS4xMDU0WiIgZmlsbD0iIzAyMUY2MSIvPgo8L3N2Zz4K')] bg-[right_0.5rem_center] bg-no-repeat pr-6",f),...t(e.id,s),onChange:u=>{n(e.id,u.target.value)},children:[o.jsx("option",{disabled:!0,value:p,children:p}),((x=e.options)!=null?x:[]).map(u=>o.jsx("option",{value:u.value,children:u.label},e.id+u.value))]});default:return null}},U=({field:e,onChange:t,type:r,isHovered:n,onMouseEnter:s,onMouseLeave:a})=>{var x;const{register:d,getValues:i,formState:{errors:l}}=X(),c=Re(e),p=Y(l,e.id),h=p.some(u=>u.type===D.ALERT),f=!h&&n,m=r===T.INPUT,N=r===T.OUTPUT,E="flex w-[34%] max-w-52 text-base font-medium text-wrap";return o.jsxs("div",{onMouseEnter:s,onMouseLeave:a,className:g("mx-8 flex h-full w-full flex-col items-center px-8 py-3",{"bg-[#FB46711A]":h,"bg-[#f0f4fc]":f&&m,"bg-[#e4eaf5]":f&&N}),children:[o.jsxs("div",{className:g("flex h-full w-full items-center gap-2",{"text-[#021F61]":N,"text-[#0B0B0B]":m}),children:[o.jsx("label",{className:g(E),children:o.jsxs("div",{className:g("relative flex h-full items-center pr-3 break-all"),children:[e.label,c.required&&o.jsx("span",{className:"absolute top-1/2 right-0 mt-1 -translate-y-1/2 transform text-[18px] font-bold text-red-500",children:"*"})]})}),o.jsx("div",{className:"flex-1",children:o.jsx("div",{className:"flex items-center",style:{maxWidth:((x=e.width)!=null?x:200)+"px"},children:ke(e,d,i(),t,c,m,N,h)})})]}),o.jsxs("div",{className:"flex w-full gap-2",children:[o.jsx("div",{className:g(E)}),o.jsx("div",{className:"flex-1",children:p.map((u,b)=>o.jsxs("div",{className:"mt-0.5 flex text-sm font-medium",children:[o.jsx("div",{className:"mt-1 mr-[6px]",children:u.type===D.ALERT?o.jsx(se,{width:12,height:12}):o.jsx(re,{width:12,height:12})}),o.jsx("div",{className:g("flex-1",{"text-[#FB4671]":u.type===D.ALERT,"text-[#497EDC]":u.type===D.REMINDER}),children:u.content})]},e.id+b))})]})]})},Ve=({inputField:e,outputField:t,isLastRow:r,isFirstRow:n,index:s,onChange:a})=>{const[d,i]=v.useState(null),l=p=>{i(p)},c=()=>{i(null)};return o.jsxs("div",{className:g("flex justify-between gap-6",{}),children:[o.jsx("div",{className:g("flex flex-1 border-x-2 border-[#497EDC] bg-white",{"rounded-b-[6px] border-b-2 border-[#497EDC] pb-2":r,"pt-2":n}),children:e&&o.jsx(U,{onMouseEnter:()=>{l(s)},onMouseLeave:c,isHovered:d===s,type:T.INPUT,onChange:a,field:e},e.id)}),o.jsx("div",{className:g("flex flex-1 border-x-2 border-[#021F613D] bg-[#f4f5f8]",{"rounded-b-[6px] border-b-2 border-[#021F613D] pb-2":r,"pt-2":n}),children:t&&o.jsx(U,{onMouseEnter:()=>{l(s)},onMouseLeave:c,isHovered:d===s,type:T.OUTPUT,onChange:a,field:t},t.id)})]})},Le=z(),Be=({section:e,onChange:t})=>{const[r,n]=v.useState(!1),s=e.fields[0].length;return o.jsxs("div",{className:"p-4",children:[o.jsxs("div",{onClick:()=>n(!r),className:"flex cursor-pointer items-center justify-between",children:[o.jsxs("h2",{className:"flex items-center text-xl font-bold select-none",children:[o.jsx("span",{className:"mr-4 inline-block h-5 w-[5px] rounded-[999px] bg-[linear-gradient(90deg,#7EBD31,#00BBC2)]"}),e.sectionName]}),o.jsx("div",{className:g({"rotate-180":r}),children:o.jsx(oe,{})})]}),o.jsxs("div",{className:g("mt-4 gap-4",{hidden:r}),children:[o.jsxs("div",{className:"flex justify-between gap-6",children:[o.jsx("div",{className:"flex-1 rounded-t-[6px] bg-[#497EDC] py-2 text-center text-sm font-bold text-white",children:"EN/Worklog/Email"}),o.jsx("div",{className:"flex-1 rounded-t-[6px] bg-[#021F613D] py-2 text-center text-sm font-bold text-[#021F61]",children:Le})]}),e.fields[0].map((a,d)=>{var p;const i=e.fields[0][d],l=e.fields[1][d],c=e.sectionName+((p=i==null?void 0:i.id)!=null?p:l==null?void 0:l.id);return o.jsx(Ve,{inputField:i,outputField:l,onChange:t,isLastRow:d===s-1,isFirstRow:d===0,index:d},c)})]})]})},Ue=v.memo(({sections:e,fieldKeyMap:t,formRef:r,initialValues:n})=>{const s=Object.keys(t);console.log("re-render1111",e);const a=q({criteriaMode:"all",defaultValues:n}),{formState:{errors:d}}=a;v.useImperativeHandle(r,()=>({validateFields:async()=>{if(!await a.trigger()){const c=Te(d),p=Object.keys(c).reduce((f,m)=>{var x;const N=B(m);(x=f[N])!=null||(f[N]=[]);const E=c[m].filter(u=>u.type===D.REMINDER).map(u=>u.content);return f[N]=f[N].concat(E),f},{});return{hasErrors:Object.keys(c).some(f=>c[f].filter(N=>N.type===D.ALERT).length>0),reminderMessages:p}}return{hasErrors:!1,reminderMessages:{}}}}));const i=(l,c)=>{console.log("change name",l,c);const p=B(l);y.updateValue(p,Oe(t[p].type)(c));const h=y.getValues();y.getAffectedNodes(p).filter(m=>s.includes(m)).concat(p).forEach(m=>{t[m].registeredNames.forEach(E=>{a.setValue(E,H(t[m].type)(h[m]),{shouldValidate:!0})})})};return v.useEffect(()=>{setTimeout(a.trigger,0)},[n]),o.jsx(ee,{...a,children:o.jsx("form",{children:e.map(l=>o.jsx("div",{className:"mb-5 rounded-[5px] bg-white",children:o.jsx(Be,{section:l,onChange:i})},l.sectionName))})})},(e,t)=>t.isActive===!1);y.computeAll();const K=y.getValues(),w=me,{fieldKeyMap:I}=Se(w),Pe=be(K);console.log(I,"fieldKeyMap");let M=!1;const ze=()=>{const[e,t]=v.useState(0),r=v.useRef(w.map(()=>te.createRef())),n=w[e].tabName,s=w.map((c,p)=>{const h=c.sections.filter(f=>!Pe.includes(f.sectionName));return{key:c.tabName,label:c.tabName,children:o.jsx("div",{className:"overflow-y-auto",style:{height:"calc(100vh - 200px)"},children:o.jsx(Ue,{fieldKeyMap:I[c.tabName],sections:h,formRef:r.current[p],isActive:e===p,initialValues:_e(I[c.tabName],Object.keys(I[c.tabName]))})})}}),a=()=>{e<s.length-1&&t(e+1)},d=c=>{const p=s.findIndex(h=>h.key===c);t(p===-1?0:p)},i=c=>{const{activeKey:p,onTabClick:h}=c;return o.jsx("div",{className:"mb-4 select-none",children:o.jsx("div",{className:"inline-flex rounded-[100px] border-1 border-[#E1E6EA]",children:s.map(f=>o.jsx("div",{className:g("cursor-pointer rounded-[100px] px-4 py-2 text-base font-bold text-nowrap text-[#0B0B0B]",{"bg-transparent":p!==f.key,"bg-[#021F61] text-white":p===f.key}),onClick:m=>h(f.key,m),children:f.label},f.key))})})},l=()=>{if(M)return;M=!0;const c=ue();r.current.every(h=>!!h.current)?Promise.all(r.current.map(h=>h.current.validateFields())).then(async h=>{const f=x=>x.hasErrors;if(!h.every(x=>!f(x)))return t(h.findIndex(f)),alert(c.validateFailMessage);const N=()=>h.reduce((x,u)=>(Object.keys(u.reminderMessages).forEach(b=>{var C;(C=x[b])!=null||(x[b]=[]),x[b]=x[b].concat(u.reminderMessages[b].filter(Q=>!x[b].includes(Q)))}),x),{}),E=Ee(Ie(I,K),N());De(E,c.fileMimeType,c.filename),c.needPastingToClipboard&&await ve(JSON.stringify(E,null,2)),alert(c.exportSuccessMessage)}).catch(()=>{alert(c.exportFailMessage)}).finally(()=>{M=!1}):(M=!1,alert(c.validateFailMessage),t(r.current.findIndex(h=>!h.current)))};return o.jsxs("div",{children:[o.jsx(k.Content,{children:o.jsx(ae,{renderTabBar:i,activeKey:n,onChange:d,items:s,destroyInactiveTabPane:!1})}),o.jsx(k.Footer,{className:"flex w-full items-center justify-end px-0 py-2",children:o.jsxs(ce,{size:16,children:[o.jsx(V,{onClick:l,className:"h-10 rounded-[4px] bg-[#497EDC] text-base leading-6 font-bold text-white",children:"Submit"}),o.jsx(V,{className:"h-10 rounded-[4px] bg-[#497EDC] text-base leading-6 font-bold text-white",onClick:a,children:"Next"})]})})]})},Qe=()=>o.jsx(ze,{});export{Qe as default};
